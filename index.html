<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEBULA PRO // MASTER COMMAND</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#020202">
<link rel="apple-touch-icon" href="./icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap');
        
        :root {
            --accent: #00f2ff;
            --bg-void: #020203;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-void);
            color: #fff;
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        input[type="range"] {
            appearance: none;
            background: #242429;
            height: 4px;
            border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .page { display: none; }
        .page.active { display: block; }

        .nav-item.active { color: var(--accent); }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="flex items-center justify-between px-4 py-3 border-b border-[#242429] bg-[#020203]/80 backdrop-blur-md z-50">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-[#00f2ff] animate-pulse"></div>
            <h1 class="text-[10px] font-black tracking-[3px] uppercase">Nebula<span class="text-[#00f2ff]">Pro</span></h1>
        </div>
        <div class="flex gap-2">
            <button class="p-2 bg-[#16161a] border border-[#242429] rounded-lg text-gray-400" onclick="location.reload()">
                <i class="fa-solid fa-rotate-right text-xs"></i>
            </button>
            <button class="p-2 bg-[#00f2ff] rounded-lg text-black font-bold" onclick="saveState()">
                <i class="fa-solid fa-check text-xs"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto pb-32 p-4 space-y-4">
        
        <!-- DASHBOARD -->
        <section id="page-dash" class="page active space-y-4">
            <!-- Selection Card -->
            <div class="bg-gradient-to-br from-[#111115] to-[#050506] border border-[#242429] rounded-2xl p-5 relative overflow-hidden">
                <div id="no-selection" class="text-center py-4">
                    <p class="text-sm text-gray-500">Aguardando seleção de node...</p>
                    <button onclick="scanHost()" class="mt-3 text-[10px] text-[#00f2ff] flex items-center gap-1 mx-auto uppercase tracking-widest">
                        <i class="fa-solid fa-satellite-dish"></i> SCAN DOMAIN
                    </button>
                </div>
                
                <div id="has-selection" class="hidden space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <span id="display-tag" class="text-[10px] font-mono text-[#00f2ff] border border-[#00f2ff]/30 px-2 py-0.5 rounded-full uppercase">TAG</span>
                            <h3 id="display-id" class="text-xs font-mono mt-2 text-gray-400">#id-do-elemento</h3>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-600 block mb-1">DOMAIN</span>
                            <span id="display-domain" class="text-[10px] font-mono">---</span>
                        </div>
                    </div>

                    <!-- Scope Selector -->
                    <div class="grid grid-cols-2 gap-1 bg-black p-1 rounded-xl">
                        <button onclick="setScope('single')" id="btn-scope-single" class="py-2 text-[10px] font-bold rounded-lg transition-all bg-[#16161a] text-[#00f2ff]">ELEMENTO</button>
                        <button onclick="setScope('class')" id="btn-scope-class" class="py-2 text-[10px] font-bold rounded-lg transition-all text-gray-500">CLASSE</button>
                    </div>
                </div>
            </div>

            <!-- Modulators -->
            <div class="bg-[#0d0d0f] border border-[#242429] rounded-xl overflow-hidden">
                <div class="p-4 flex items-center justify-between border-b border-[#242429]">
                    <div class="flex items-center gap-2 text-xs font-bold text-gray-300 uppercase tracking-widest">
                        <i class="fa-solid fa-sliders text-[#00f2ff]"></i> Moduladores
                    </div>
                </div>
                <div class="p-4 space-y-6">
                    <div class="mod-control" data-prop="opacity">
                        <div class="flex justify-between items-center font-mono text-[10px] mb-2">
                            <span class="text-gray-500 uppercase">Opacidade</span>
                            <span class="text-[#00f2ff] font-bold value">100%</span>
                        </div>
                        <input type="range" min="0" max="1" step="0.01" value="1" class="w-full" oninput="applyUpdate('opacity', this.value)">
                    </div>
                    <div class="mod-control" data-prop="scale">
                        <div class="flex justify-between items-center font-mono text-[10px] mb-2">
                            <span class="text-gray-500 uppercase">Escala</span>
                            <span class="text-[#00f2ff] font-bold value">1.0x</span>
                        </div>
                        <input type="range" min="0.5" max="1.5" step="0.01" value="1" class="w-full" oninput="applyUpdate('scale', this.value)">
                    </div>
                    <div class="mod-control" data-prop="translateY">
                        <div class="flex justify-between items-center font-mono text-[10px] mb-2">
                            <span class="text-gray-500 uppercase">Vertical (Y)</span>
                            <span class="text-[#00f2ff] font-bold value">0px</span>
                        </div>
                        <input type="range" min="-100" max="100" step="1" value="0" class="w-full" oninput="applyUpdate('translateY', this.value)">
                    </div>
                    <div class="mod-control" data-prop="blur">
                        <div class="flex justify-between items-center font-mono text-[10px] mb-2">
                            <span class="text-gray-500 uppercase">Blur</span>
                            <span class="text-[#00f2ff] font-bold value">0px</span>
                        </div>
                        <input type="range" min="0" max="20" step="1" value="0" class="w-full" oninput="applyUpdate('blur', this.value)">
                    </div>
                </div>
            </div>
        </section>

        <!-- TREE / NODES -->
        <section id="page-tree" class="page space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xs font-black tracking-widest text-gray-500 uppercase">Hierarquia do DOM</h2>
                <button onclick="scanHost()" class="text-[#00f2ff]"><i class="fa-solid fa-satellite-dish"></i></button>
            </div>
            <div id="tree-list" class="space-y-2">
                <!-- Nodes injetados via JS -->
            </div>
        </section>

        <!-- CONFIG -->
        <section id="page-config" class="page space-y-4">
            <h2 class="text-xs font-black tracking-widest text-gray-500 uppercase">Configurações</h2>
            <div class="bg-[#0d0d0f] border border-[#242429] rounded-xl p-4 space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-database text-purple-500 text-xs"></i>
                        <span class="text-xs">Persistência Cloud</span>
                    </div>
                    <div class="text-[10px] text-green-500 font-bold uppercase">Ativa</div>
                </div>
                <div class="flex items-center justify-between border-t border-[#242429] pt-4">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-microchip text-blue-500 text-xs"></i>
                        <span class="text-xs">Domínio Atual</span>
                    </div>
                    <span id="config-domain" class="text-[10px] font-mono text-gray-500">---</span>
                </div>
                <button onclick="localStorage.clear(); location.reload();" class="w-full py-3 bg-red-500/10 border border-red-500/20 rounded-lg text-[10px] font-bold text-red-500 uppercase tracking-widest mt-4">
                    Limpar Cache Local
                </button>
            </div>
        </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 w-full h-20 bg-[#0d0d0f]/90 backdrop-blur-xl border-t border-[#242429] grid grid-cols-3 px-2 z-[1000]">
        <button onclick="nav('dash')" class="nav-item active flex flex-col items-center justify-center gap-1" id="nav-dash">
            <i class="fa-solid fa-sliders text-lg"></i>
            <span class="text-[9px] font-black uppercase tracking-tighter">Dash</span>
        </button>
        <button onclick="nav('tree')" class="nav-item flex flex-col items-center justify-center gap-1 text-gray-500" id="nav-tree">
            <i class="fa-solid fa-layer-group text-lg"></i>
            <span class="text-[9px] font-black uppercase tracking-tighter">Nodes</span>
        </button>
        <button onclick="nav('config')" class="nav-item flex flex-col items-center justify-center gap-1 text-gray-500" id="nav-config">
            <i class="fa-solid fa-gears text-lg"></i>
            <span class="text-[9px] font-black uppercase tracking-tighter">Opções</span>
        </button>
    </nav>

    <!-- Floating Scan Button -->
    <button onclick="scanHost()" class="fixed bottom-24 right-6 w-14 h-14 bg-[#00f2ff] text-black rounded-full shadow-[0_0_30px_rgba(0,242,255,0.3)] flex items-center justify-center z-[100] active:scale-95 transition-transform">
        <i class="fa-solid fa-satellite-dish text-xl"></i>
    </button>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nebula-zebkit-v1';

        // State Global
        window.nebula = {
            user: null,
            domain: 'unknown',
            nodes: [],
            selected: null,
            scope: 'single', // 'single' | 'class'
            activeClass: '',
            mods: { opacity: 1, scale: 1, translateY: 0, blur: 0 }
        };

        // Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.nebula.user = user;
                console.log("Nebula Auth OK");
            } else {
                signInAnonymously(auth);
            }
        });

        // Funções exportadas para o escopo global (onClick)
        window.nav = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.add('text-gray-500'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + pageId).classList.add('active');
            document.getElementById('nav-' + pageId).classList.remove('text-gray-500');
        };

        window.scanHost = () => {
            window.parent.postMessage({ type: 'NEBULA_SCAN_REQ' }, '*');
        };

        window.setScope = (mode) => {
            window.nebula.scope = mode;
            const btnSingle = document.getElementById('btn-scope-single');
            const btnClass = document.getElementById('btn-scope-class');
            
            if(mode === 'single') {
                btnSingle.className = "py-2 text-[10px] font-bold rounded-lg transition-all bg-[#16161a] text-[#00f2ff]";
                btnClass.className = "py-2 text-[10px] font-bold rounded-lg transition-all text-gray-500";
            } else {
                btnClass.className = "py-2 text-[10px] font-bold rounded-lg transition-all bg-[#16161a] text-[#bd00ff]";
                btnSingle.className = "py-2 text-[10px] font-bold rounded-lg transition-all text-gray-500";
            }
            // Trigger update to sync host
            window.applyUpdate('opacity', window.nebula.mods.opacity);
        };

        window.selectNode = (id) => {
            const node = window.nebula.nodes.find(n => n.id === id);
            if(!node) return;

            window.nebula.selected = node;
            window.nebula.activeClass = (node.classes || '').split(' ').filter(Boolean)[0] || '';

            // UI
            document.getElementById('no-selection').classList.add('hidden');
            document.getElementById('has-selection').classList.remove('hidden');
            document.getElementById('display-tag').innerText = node.tag;
            document.getElementById('display-id').innerText = "#" + node.id.substring(0, 16);
            document.getElementById('btn-scope-class').innerText = `CLASSE (${window.nebula.activeClass || 'N/A'})`;

            window.nav('dash');
            window.parent.postMessage({ type: 'NEBULA_HIGHLIGHT', id: node.id }, '*');
            renderTree();
        };

        window.applyUpdate = (prop, val) => {
            if(!window.nebula.selected) return;
            
            window.nebula.mods[prop] = val;
            
            // UI Update Value Display
            const control = document.querySelector(`.mod-control[data-prop="${prop}"]`);
            const label = control.querySelector('.value');
            if(prop === 'opacity') label.innerText = Math.round(val * 100) + '%';
            if(prop === 'scale') label.innerText = parseFloat(val).toFixed(2) + 'x';
            if(prop === 'translateY' || prop === 'blur') label.innerText = val + 'px';

            const styles = {
                opacity: window.nebula.mods.opacity,
                transform: `scale(${window.nebula.mods.scale}) translateY(${window.nebula.mods.translateY}px)`,
                filter: `blur(${window.nebula.mods.blur}px)`,
                transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
            };

            window.parent.postMessage({
                type: 'NEBULA_UPDATE_STYLE',
                id: window.nebula.selected.id,
                className: window.nebula.scope === 'class' ? window.nebula.activeClass : null,
                styles: styles
            }, '*');

            debounceSave();
        };

        // Cloud Persistence
        let saveTimeout;
        const debounceSave = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if(!window.nebula.user || !window.nebula.selected) return;
                
                const target = window.nebula.scope === 'class' ? window.nebula.activeClass : window.nebula.selected.id;
                const docId = `${window.nebula.domain}_${target}`.replace(/[\.#$\[\]]/g, '_');
                
                try {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'modulations', docId);
                    await setDoc(ref, {
                        target: target,
                        type: window.nebula.scope,
                        mods: window.nebula.mods,
                        domain: window.nebula.domain,
                        updatedAt: Date.now()
                    }, { merge: true });
                } catch(e) { console.warn("Cloud Save Error", e); }
            }, 1000);
        };

        // Listen for host
        window.addEventListener('message', (e) => {
            const d = e.data;
            if(d.type === 'NEBULA_SCAN_RES') {
                window.nebula.nodes = d.tree || [];
                window.nebula.domain = d.domain || 'unknown';
                document.getElementById('display-domain').innerText = window.nebula.domain;
                document.getElementById('config-domain').innerText = window.nebula.domain;
                renderTree();
            }
        });

        function renderTree() {
            const list = document.getElementById('tree-list');
            list.innerHTML = '';
            window.nebula.nodes.forEach(node => {
                const isSelected = window.nebula.selected?.id === node.id;
                const div = document.createElement('div');
                div.onclick = () => window.selectNode(node.id);
                div.className = `flex items-center gap-3 p-3 rounded-xl border transition-all cursor-pointer ${isSelected ? 'bg-[#00f2ff]/10 border-[#00f2ff]' : 'bg-[#0d0d0f] border-[#242429]'}`;
                div.innerHTML = `
                    <div class="p-2 rounded-lg ${isSelected ? 'bg-[#00f2ff] text-black' : 'bg-[#16161a] text-gray-500'}">
                        <i class="fa-solid fa-cube text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold truncate">${node.tag.toUpperCase()}</span>
                            <span class="text-[9px] text-gray-600 font-mono">${node.text.substring(0, 15)}</span>
                        </div>
                        <p class="text-[9px] text-gray-500 font-mono truncate">${node.classes || 'no-class'}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Auto Scan on load
        setTimeout(window.scanHost, 1000);
    </script>
</body>
</html>
